# aPEAR wrapper


We provide a wrapper function for running aPEAR for network-based analysis enrichment analysis. This can be used after the pipeline is run.

Network based enrichment analysis can be useful because pathways can often be quite redundant and overlap quite a bit in the genes making up the gene set. Network methods like aPEAR allow classification of enriched pathways into functional modules, allowing a more comprehensive and less redundant approach to pathway enrichment analysis.


Steps:
1. Run pipeline
2. Run `scDAPP::apear_data_prep()`
3. Run `scDAPP::apear_find_clusters()`
4. Run `scDAPP::apear_update_and_save_input()`
5. Run `scDAPP::apear_plot_cluster()`



NOTE 2025.02.19

aPEAR was apparently removed from CRAN on 2025.01.10.

Run the below code to install aPEAR from the CRAN archive along with dependencies.
```
remotes::install_url('https://cran.r-project.org/src/contrib/Archive/aPEAR/aPEAR_1.0.0.tar.gz')
```




## 1. Inputs from pipeline: 

From the pipeline, you will need the file `DE_pathways_plot_objects_list.rds`, which can be found below:



```
scDAPP_outdir/
├── individualsample_analysis
├── multisample_integration
│   └── pathwayanalysis_crosscondition
│        └──**DE_pathways_plot_objects_list.rds**
├── pipeline_parameters.csv
└── scRNAseq_clustering_integration.html
```

Read in that file, for example:

```
pathway_analysis_result <- readRDS("multisample_integration/pathwayanalysis_crosscondition/DE_pathways_plot_objects_list.rds")

```


## 2. Format DE object for aPEAR using scDAPP output:

You will convert gene set enrichment analysis (GSEA) results from scDAPP pipeline across different conditions into a format compatible with aPEAR.

```
apear_input_list <- apear_data_prep(pathway_analysis_result)
```



## 3. Select Pathways and Calculate aPEAR Clusters

You will select pathways based on P-value and Leading Edge (LE) genes and calculate aPEAR clusters. 

This function serves as a wrapper for the `findPathCluster` function in the aPEAR package. It processes the output from the `apear_data_prep` function, filters pathways based on the number of leading edge genes, and selects pathways with the most significant p-values.

Note: `findPathClusterres.rds` is saved if save_cluster_parameters_and_results = TRUE. 

```
findPathClusterres <- apear_find_clusters(apear_input_list,
                                          max_sign_pathway = 500,
                                          min_leading_edge_threshold = 2,
                                          output_dir = "path/to/save",
                                          save_cluster_parameters_and_results = TRUE) 
```

## 4. Update and Save aPEAR Input Data 

You will then update the originial `apear_input_list` with leading edge gene information ("number_of_LE_genes"), the information of whether a pathway is selected for aPEAR clustering ("Select_for_aPEAR"), and the resulting aPEAR cluster ("aPEAR_Cluster"). You can save the result if specified.

Note: `aPEARres.rds` is saved if save_apear_input = TRUE.

```
apear_input_list_updated <- apear_update_and_save_input(apear_input_list,
                                                        findPathClusterres,
                                                        output_dir = "path/to/save",
                                                        save_apear_input = TRUE)
```

## 5. Plot aPEAR Clusters

You will visualize clusters generated by aPEAR analysis using the updated aPEAR input list and the clustering results. You can customize the plot appearance and save the plot and aPEAR results object.

Note: `_aPEAR_markov_network.pdf` files are saved if save_network_plot = TRUE.
      `_aPEAR_input.csv` files are saved if save_apearres_obj = TRUE.

```
#Assuming the comparison has two conditions (Control and KO)

apear_network_list <-  apear_plot_cluster(apear_input_list_updated,
                                          findPathClusterres,
                                          color_mapping = c(Control = "blue", KO = "red"),
                                          fontSize = 2.5,
                                          output_dir = "path/to/save",
                                          output_width = 10,
                                          output_height = 10,
                                          save_network_plot = TRUE,
                                          save_apearres_obj = TRUE)
```

## 6. Sample outputs from aPEAR Functions:
```
aPEAR_output_dir/
├── KO_vs_Control
│   ├── cluster_1_aPEAR_markov_network.pdf
│   ├── cluster_2_aPEAR_markov_network.pdf
│   ├── cluster_3_aPEAR_markov_network.pdf
│   ├── cluster_4_aPEAR_markov_network.pdf
│   ├── cluster_5_aPEAR_markov_network.pdf
│   └── inputs
│       ├── KO_vs_Control_cluster_1_aPEAR_input.csv
│       ├── KO_vs_Control_cluster_2_aPEAR_input.csv
│       ├── KO_vs_Control_cluster_3_aPEAR_input.csv
│       ├── KO_vs_Control_cluster_4_aPEAR_input.csv
│       ├── KO_vs_Control_cluster_5_aPEAR_input.csv
├── aPEARres.rds
└── findPathClusterres.rds
```

## Caveats
1. As of 03/11/2024, aPEAR is solely available on Biorxiv, a preprint platform. It is anticipated that revisions will be made for its formal publication.
2. The current version of aPEAR on GitHub lacks the findPathCluster function. It is recommended to install the CRAN version of aPEAR (v1.0.0) to access this functionality.
3. Occasionally, labels in the final outputs may be missing or placed suboptimally. To enhance the reliability of the final visualizations, it is advised to execute and save the outcomes of the step 5 (Plot aPEAR Clusters) multiple times.
4. For step 3, "Select Pathways and Calculate aPEAR Clusters," setting the max_sign_pathway parameter to a threshold greater than 1000 may significantly slow down the calculation and result in an overcrowded final network. We recommend using a threshold of 500 or less for the max_sign_pathway parameter. Similarly, we advise setting the min_leading_edge_threshold parameter to 2 or higher. Using a lower min_leading_edge_threshold may prevent the Markov cluster algorithm from being able to perform calculations.
